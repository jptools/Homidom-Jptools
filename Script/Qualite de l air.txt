Imports System
Imports System.IO
Imports System.Windows.Forms
Imports Microsoft.VisualBasic
Imports Homidom    
Imports System.Xml
Imports System.Xml.XPath
Imports System.Xml.Serialization    
Imports System.Net                                                          
Namespace Dynam
'Ne pas supprimer cette class
Public Class DynamicCode
   
  'Ne pas supprimer cette function 
  Public Function ExecuteCode(paramarray prmParameters() as object) as object
    Dim _serveur as Homidom.Homidom.server
    _serveur = prmParameters(0)
    try
            Dim ville as String = "MULHOUSE"
            Dim IdComposant as String = "7ba1e410-b118-4f27-9bbc-8af8054b9875"
            Dim IdDuServer as string = "123456789"

            Dim doc As New XmlDocument
            Dim nodes As XmlNodeList
            Dim indice as String = ""
            Dim agglomeration as String = ""
            
            _serveur.log(10, 2, "Macro VB:QualiteAirAction", "Chargement de  http://www.lcsqa.org/surveillance/indices/prevus/jour/xml/" & DateAndTime.Now.ToString("yyyy-MM-dd"))
            doc = New XmlDocument()
            Dim url As New Uri("http://www.lcsqa.org/surveillance/indices/prevus/jour/xml/" & DateAndTime.Now.ToString("yyyy-MM-dd"))
            Dim Request As HttpWebRequest = CType(HttpWebRequest.Create(url), System.Net.HttpWebRequest)
            ' Request.UserAgent = "Mozilla/5.0 (windows; U; windows NT 5.1; fr; rv:1.8.0.7) Gecko/20060909 Firefox/1.5.0.7"
            Dim response As Net.HttpWebResponse = CType(Request.GetResponse(), Net.HttpWebResponse)

            doc.Load(response.GetResponseStream)
            nodes = doc.SelectNodes("/root/node")
            For Each node As XmlNode In nodes
                 indice = ""
                 agglomeration = ""
                 For Each _child As XmlNode In node
                       Select Case _child.Name
                              Case "valeurIndice" : indice = _child.FirstChild.Value
                              Case "agglomeration" : agglomeration = _child.FirstChild.Value
                       End Select
                 Next
                 '_serveur.log(10, 2, "Macro VB:QualiteAirAction", "Test: " & agglomeration & " : " & indice)
                 If (agglomeration = ville) then
                        _serveur.log(1, 2, "Macro VB:QualiteAirAction", "Trouvé: " & ville & " : " & indice)
                        _serveur.ChangeValueOfDevice(IdDuServer,IdComposant ,indice)
                        exit for
                 End If
            Next

    Catch ex As Exception
       _serveur.log(8, 2, "Macro VB:QualiteAirAction", "Exception: " & ex.message)
    End Try
  End Function

End Class
End Namespace